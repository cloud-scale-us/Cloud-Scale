<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">

    <Package Name="Scale Streamer v3.4.4 (Self-Contained)"
             Manufacturer="Cloud-Scale"
             Version="3.4.4"
             UpgradeCode="B2C3D4E5-F6A7-8901-BCDE-FA2345678902"
             Scope="perMachine">

        <SummaryInformation Description="Scale Streamer v3.4.4 - Enhanced TCP diagnostics and logging"
                            Manufacturer="Cloud-Scale" />

        <MajorUpgrade DowngradeErrorMessage="A newer version of Scale Streamer is already installed."
                      Schedule="afterInstallInitialize" />

        <Media Id="1" Cabinet="ScaleStreamer.cab" EmbedCab="yes" CompressionLevel="high" />

        <!-- Properties -->
        <Property Id="LAUNCHCONFIGONEXIT" Value="1" />
        <Property Id="STARTSERVICEONEXIT" Value="1" />

        <!-- Directory Structure -->
        <StandardDirectory Id="ProgramFiles64Folder">
            <Directory Id="INSTALLFOLDER" Name="Scale Streamer">
                <!-- Service Directory -->
                <Directory Id="ServiceFolder" Name="Service" />

                <!-- Configuration GUI Directory -->
                <Directory Id="ConfigFolder" Name="Config" />

                <!-- Launcher Directory -->
                <Directory Id="LauncherFolder" Name="Launcher" />

                <!-- Protocol Templates Directory -->
                <Directory Id="ProtocolsFolder" Name="protocols">
                    <Directory Id="ManufacturersFolder" Name="manufacturers" />
                    <Directory Id="GenericProtocolsFolder" Name="generic" />
                </Directory>

                <!-- Documentation Directory -->
                <Directory Id="DocsFolder" Name="docs" />
            </Directory>
        </StandardDirectory>

        <!-- Common Application Data (for database and logs) -->
        <StandardDirectory Id="CommonAppDataFolder">
            <Directory Id="AppDataFolder" Name="ScaleStreamer">
                <Directory Id="LogsFolder" Name="logs" />
                <Directory Id="BackupsFolder" Name="backups" />
            </Directory>
        </StandardDirectory>

        <StandardDirectory Id="ProgramMenuFolder">
            <Directory Id="ApplicationProgramsFolder" Name="Scale Streamer" />
        </StandardDirectory>

        <StandardDirectory Id="DesktopFolder" />

        <!-- ================================================================ -->
        <!-- SERVICE COMPONENTS -->
        <!-- ================================================================ -->
        <!-- Note: ServiceRuntimeComponents will be generated by heat.exe -->
        <!-- This group contains the service executable and Windows Service registration -->
        <ComponentGroup Id="ServiceInstallComponents" Directory="ServiceFolder">
            <Component Id="ServiceExecutableComponent" Guid="A1111111-1111-1111-1111-111111111101">
                <File Id="ServiceExe"
                      Source="$(var.ServicePublishDir)\ScaleStreamer.Service.exe"
                      KeyPath="yes" />

                <!-- Windows Service Configuration -->
                <ServiceInstall Id="ScaleStreamerService"
                                Name="ScaleStreamerService"
                                DisplayName="Scale Streamer Service"
                                Description="Cloud-Scale Scale Streamer - Manages scale connections and data streaming"
                                Type="ownProcess"
                                Start="auto"
                                Account="LocalSystem"
                                ErrorControl="normal"
                                Interactive="no">
                    <util:ServiceConfig FirstFailureActionType="restart"
                                       SecondFailureActionType="restart"
                                       ThirdFailureActionType="restart"
                                       RestartServiceDelayInSeconds="60" />
                </ServiceInstall>

                <ServiceControl Id="StartService"
                               Name="ScaleStreamerService"
                               Start="install"
                               Stop="both"
                               Remove="uninstall"
                               Wait="yes" />
            </Component>
        </ComponentGroup>

        <!-- ================================================================ -->
        <!-- CONFIGURATION GUI COMPONENTS -->
        <!-- ================================================================ -->
        <!-- Note: ConfigRuntimeComponents will be generated by heat.exe -->
        <!-- Logo files (logo.png, logo.ico) are automatically included by heat.exe -->

        <!-- ================================================================ -->
        <!-- LAUNCHER COMPONENTS -->
        <!-- ================================================================ -->
        <!-- Note: LauncherRuntimeComponents will be generated by heat.exe -->

        <!-- ================================================================ -->
        <!-- PROTOCOL TEMPLATES -->
        <!-- ================================================================ -->
        <ComponentGroup Id="ProtocolComponents" Directory="ProtocolsFolder">
            <!-- Manufacturer-specific protocols -->
            <Component Id="ProtocolFairbanks6011" Directory="ManufacturersFolder" Guid="C3333333-3333-3333-3333-333333333331">
                <File Source="..\protocols\manufacturers\fairbanks-6011.json" KeyPath="yes" />
            </Component>

            <!-- Generic protocols -->
            <Component Id="ProtocolGenericAscii" Directory="GenericProtocolsFolder" Guid="C3333333-3333-3333-3333-333333333332">
                <File Source="..\protocols\generic\generic-ascii.json" KeyPath="yes" />
            </Component>

            <Component Id="ProtocolModbusTcp" Directory="GenericProtocolsFolder" Guid="C3333333-3333-3333-3333-333333333333">
                <File Source="..\protocols\generic\modbus-tcp.json" KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- ================================================================ -->
        <!-- DOCUMENTATION -->
        <!-- ================================================================ -->
        <ComponentGroup Id="DocumentationComponents" Directory="DocsFolder">
            <Component Id="DocQuickStart" Guid="D4444444-4444-4444-4444-444444444441">
                <File Source="..\QUICK-START-V2.md" KeyPath="yes" />
            </Component>

            <Component Id="DocBuildAndTest" Guid="D4444444-4444-4444-4444-444444444442">
                <File Source="..\BUILD-AND-TEST-V2.md" KeyPath="yes" />
            </Component>

            <Component Id="DocArchitecture" Guid="D4444444-4444-4444-4444-444444444443">
                <File Source="..\V2-UNIVERSAL-ARCHITECTURE.md" KeyPath="yes" />
            </Component>

            <Component Id="DocDiagnostics" Guid="D4444444-4444-4444-4444-444444444444">
                <File Source="..\DIAGNOSTICS-INSTRUCTIONS.md" KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- ================================================================ -->
        <!-- DIAGNOSTIC TOOLS -->
        <!-- ================================================================ -->
        <ComponentGroup Id="DiagnosticComponents" Directory="INSTALLFOLDER">
            <Component Id="DiagnosticsScript" Guid="D5555555-5555-5555-5555-555555555551">
                <File Id="CollectDiagnostics" Source="..\collect-diagnostics.ps1" KeyPath="yes" />
            </Component>

            <Component Id="ScaleTestTool" Guid="D5555555-5555-5555-5555-555555555552">
                <File Id="ScaleTestToolExe"
                      Source="..\src-v2\ScaleStreamer.TestTool\bin\Release\net8.0\win-x64\publish\ScaleStreamer.TestTool.exe"
                      KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- ================================================================ -->
        <!-- APPLICATION DATA DIRECTORIES -->
        <!-- ================================================================ -->
        <ComponentGroup Id="AppDataComponents" Directory="AppDataFolder">
            <Component Id="LogsDirectory" Directory="LogsFolder" Guid="E5555555-5555-5555-5555-555555555551">
                <CreateFolder />
                <RegistryValue Root="HKLM"
                              Key="Software\Cloud-Scale\ScaleStreamer"
                              Name="LogsPath"
                              Type="string"
                              Value="[LogsFolder]"
                              KeyPath="yes" />
            </Component>

            <Component Id="BackupsDirectory" Directory="BackupsFolder" Guid="E5555555-5555-5555-5555-555555555552">
                <CreateFolder />
                <RegistryValue Root="HKLM"
                              Key="Software\Cloud-Scale\ScaleStreamer"
                              Name="BackupsPath"
                              Type="string"
                              Value="[BackupsFolder]"
                              KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- ================================================================ -->
        <!-- REGISTRY KEYS -->
        <!-- ================================================================ -->
        <ComponentGroup Id="RegistryComponents" Directory="INSTALLFOLDER">
            <Component Id="AppRegistryKeys" Guid="F6666666-6666-6666-6666-666666666661">
                <RegistryKey Root="HKLM" Key="Software\Cloud-Scale\ScaleStreamer">
                    <RegistryValue Name="InstallPath" Type="string" Value="[INSTALLFOLDER]" />
                    <RegistryValue Name="Version" Type="string" Value="3.4.4" />
                    <RegistryValue Name="Vendor" Type="string" Value="Cloud-Scale" />
                    <RegistryValue Name="SupportURL" Type="string" Value="https://cloud-scale.us/support" />
                    <RegistryValue Name="ServicePath" Type="string" Value="[ServiceFolder]" />
                    <RegistryValue Name="ConfigPath" Type="string" Value="[ConfigFolder]" />
                    <RegistryValue Name="ProtocolsPath" Type="string" Value="[ProtocolsFolder]" KeyPath="yes" />
                </RegistryKey>
            </Component>

            <!-- Firewall Port Registry -->
            <Component Id="FirewallRegistry" Guid="F6666666-6666-6666-6666-666666666662">
                <RegistryKey Root="HKLM" Key="Software\Cloud-Scale\ScaleStreamer\Firewall">
                    <RegistryValue Name="RTSP" Type="integer" Value="8554" />
                    <RegistryValue Name="HLS" Type="integer" Value="8888" KeyPath="yes" />
                </RegistryKey>
            </Component>
        </ComponentGroup>

        <!-- ================================================================ -->
        <!-- START MENU SHORTCUTS -->
        <!-- ================================================================ -->
        <ComponentGroup Id="ShortcutComponents" Directory="ApplicationProgramsFolder">
            <Component Id="StartMenuShortcuts" Guid="77777777-7777-7777-7777-777777777771">
                <Shortcut Id="ConfigShortcut"
                          Name="Scale Streamer"
                          Description="Start service and open Scale Streamer configuration"
                          Target="[LauncherFolder]ScaleStreamer.Launcher.exe"
                          WorkingDirectory="LauncherFolder"
                          Icon="ScaleStreamerIcon" />

                <Shortcut Id="ServiceControlShortcut"
                          Name="Service Control Panel"
                          Description="Open Windows Services to manage Scale Streamer Service"
                          Target="[System64Folder]services.msc"
                          Arguments="/s" />

                <Shortcut Id="DocsShortcut"
                          Name="Documentation"
                          Description="View Scale Streamer documentation"
                          Target="[DocsFolder]" />

                <Shortcut Id="UninstallShortcut"
                          Name="Uninstall Scale Streamer"
                          Description="Uninstall Scale Streamer"
                          Target="[System64Folder]msiexec.exe"
                          Arguments="/x [ProductCode]" />

                <RemoveFolder Id="CleanUpShortcutFolder" On="uninstall" />
                <RegistryValue Root="HKCU" Key="Software\ScaleStreamer" Name="installed" Type="integer" Value="1" KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- ================================================================ -->
        <!-- DESKTOP SHORTCUT -->
        <!-- ================================================================ -->
        <ComponentGroup Id="DesktopShortcutComponents" Directory="DesktopFolder">
            <Component Id="DesktopShortcut" Guid="88888888-8888-8888-8888-888888888881">
                <Shortcut Id="DesktopConfigShortcut"
                          Name="Scale Streamer"
                          Description="Start service and open Scale Streamer configuration"
                          Target="[LauncherFolder]ScaleStreamer.Launcher.exe"
                          WorkingDirectory="LauncherFolder"
                          Icon="ScaleStreamerIcon" />
                <RegistryValue Root="HKCU" Key="Software\ScaleStreamer" Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes" />
            </Component>
        </ComponentGroup>

        <!-- ================================================================ -->
        <!-- CUSTOM ACTIONS -->
        <!-- ================================================================ -->

        <!-- Add Firewall Rules -->
        <CustomAction Id="AddFirewallRules"
                      Directory="INSTALLFOLDER"
                      Execute="deferred"
                      Impersonate="no"
                      ExeCommand='cmd.exe /c netsh advfirewall firewall add rule name="Scale Streamer - RTSP" dir=in action=allow protocol=TCP localport=8554 &amp; netsh advfirewall firewall add rule name="Scale Streamer - HLS" dir=in action=allow protocol=TCP localport=8888'
                      Return="ignore" />

        <!-- Remove Firewall Rules -->
        <CustomAction Id="RemoveFirewallRules"
                      Directory="INSTALLFOLDER"
                      Execute="deferred"
                      Impersonate="no"
                      ExeCommand='cmd.exe /c netsh advfirewall firewall delete rule name="Scale Streamer - RTSP" &amp; netsh advfirewall firewall delete rule name="Scale Streamer - HLS"'
                      Return="ignore" />

        <!-- Initialize Database no longer needed, service auto-creates on first run -->

        <!-- Launch Configuration App -->
        <CustomAction Id="LaunchConfigApp"
                      Directory="ConfigFolder"
                      ExeCommand='"[ConfigFolder]ScaleStreamer.Config.exe"'
                      Return="asyncNoWait" />

        <!-- ================================================================ -->
        <!-- INSTALL SEQUENCE -->
        <!-- ================================================================ -->
        <InstallExecuteSequence>
            <!-- Firewall rules -->
            <Custom Action="AddFirewallRules" After="InstallFiles" Condition="NOT Installed" />
            <Custom Action="RemoveFirewallRules" After="RemoveFiles" Condition="Installed AND NOT REINSTALL" />

            <!-- Database initialization removed, service auto-creates on first run -->

            <!-- Launch config app after install -->
            <Custom Action="LaunchConfigApp" After="InstallFinalize" Condition="LAUNCHCONFIGONEXIT AND NOT Installed" />
        </InstallExecuteSequence>

        <!-- ================================================================ -->
        <!-- FEATURES -->
        <!-- ================================================================ -->
        <Feature Id="MainFeature" Title="Scale Streamer Core" Level="1"
                 Description="Core service, smart launcher, and configuration application (self-contained with .NET runtime)"
                 ConfigurableDirectory="INSTALLFOLDER" AllowAbsent="no">
            <ComponentGroupRef Id="ServiceInstallComponents" />
            <ComponentGroupRef Id="ServiceRuntimeComponents" />
            <ComponentGroupRef Id="ConfigRuntimeComponents" />
            <ComponentGroupRef Id="LauncherRuntimeComponents" />
            <ComponentGroupRef Id="ProtocolComponents" />
            <ComponentGroupRef Id="AppDataComponents" />
            <ComponentGroupRef Id="RegistryComponents" />
            <ComponentGroupRef Id="ShortcutComponents" />
            <ComponentGroupRef Id="DesktopShortcutComponents" />
            <ComponentGroupRef Id="DiagnosticComponents" />
        </Feature>

        <Feature Id="DocumentationFeature" Title="Documentation" Level="1"
                 Description="User guides, technical documentation, and diagnostic instructions">
            <ComponentGroupRef Id="DocumentationComponents" />
        </Feature>

        <!-- ================================================================ -->
        <!-- USER INTERFACE -->
        <!-- ================================================================ -->
        <ui:WixUI Id="WixUI_FeatureTree" />

        <!-- License Agreement -->
        <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />

        <!-- Installer Images -->
        <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />
        <WixVariable Id="WixUIDialogBmp" Value="dialog.bmp" />

        <!-- ================================================================ -->
        <!-- PRODUCT INFORMATION -->
        <!-- ================================================================ -->

        <!-- Icon for Add/Remove Programs -->
        <Icon Id="ScaleStreamerIcon" SourceFile="icon.ico" />
        <Property Id="ARPPRODUCTICON" Value="ScaleStreamerIcon" />
        <Property Id="ARPURLINFOABOUT" Value="https://cloud-scale.us" />
        <Property Id="ARPHELPLINK" Value="https://cloud-scale.us/support" />
        <Property Id="ARPCONTACT" Value="admin@cloud-scale.us" />

        <!-- Enable verbose logging -->
        <Property Id="MsiLogging" Value="voicewarmup" />

    </Package>
</Wix>
